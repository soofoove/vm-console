<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VM Console ‚Äî iOS-style (–∂–∏–≤–æ–π UI)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f2f2f7;
      --surface:rgba(255,255,255,.78);
      --surface-strong:rgba(255,255,255,.92);
      --border:rgba(60,60,67,.12);
      --separator:rgba(60,60,67,.18);
      --text:#111113;
      --muted:rgba(60,60,67,.72);

      --blue:#0a84ff;
      --green:#34c759;
      --orange:#ff9f0a;
      --red:#ff3b30;
      --gray:#8e8e93;

      --radius-xl:22px;
      --radius-lg:18px;
      --radius-md:14px;

      --shadow-soft:0 10px 30px rgba(0,0,0,.08);
      --shadow-card:0 8px 18px rgba(0,0,0,.06);
      --shadow-inset:inset 0 1px 0 rgba(255,255,255,.55);

      --blur:18px;
    }

    html, body { height: 100%; }
    body{
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(10,132,255,.18), transparent 55%),
        radial-gradient(900px 600px at 95% 0%, rgba(52,199,89,.14), transparent 55%),
        radial-gradient(800px 500px at 60% 110%, rgba(255,159,10,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text",
                   "Segoe UI", Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .sidebar{
      position: sticky;
      top: 0;
      height: 100vh;
      background: var(--surface);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-right: 1px solid var(--border);
    }

    .topbar{
      background: var(--surface);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-card), var(--shadow-inset);
      padding: 14px 16px;
    }

    .brand-badge{
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(10,132,255,.95), rgba(52,199,89,.85));
      display: inline-flex; align-items: center; justify-content: center;
      color: white; font-weight: 800;
      box-shadow: 0 10px 20px rgba(10,132,255,.18);
      letter-spacing: .2px;
    }

    .nav-pill{
      border-radius: 14px;
      padding: .60rem .75rem;
      color: var(--text);
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
    }
    .nav-pill:hover{
      background: rgba(10,132,255,.08);
      border-color: rgba(10,132,255,.20);
    }
    .nav-pill.active{
      background: rgba(10,132,255,.12);
      border-color: rgba(10,132,255,.26);
      box-shadow: var(--shadow-inset);
      font-weight: 700;
    }

    .card-ios{
      background: var(--surface);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-card), var(--shadow-inset);
    }
    .text-muted-2{ color: var(--muted) !important; }

    .input-ios, .select-ios{
      background: rgba(255,255,255,.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow-inset);
      color: var(--text);
    }
    .input-ios:focus, .select-ios:focus{
      border-color: rgba(10,132,255,.45);
      box-shadow: 0 0 0 .25rem rgba(10,132,255,.16), var(--shadow-inset);
    }

    .btn-ios{
      border-radius: 999px;
      padding: .55rem .95rem;
      font-weight: 700;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow-inset), var(--shadow-card);
      color: var(--text);
    }
    .btn-ios:hover{ background: rgba(255,255,255,.92); }
    .btn-ios-primary{
      border-radius: 999px;
      padding: .55rem 1rem;
      font-weight: 800;
      border: 1px solid rgba(10,132,255,.35);
      background: rgba(10,132,255,.94);
      color: #fff;
      box-shadow: 0 10px 24px rgba(10,132,255,.22);
    }
    .btn-ios-primary:hover{ filter: brightness(.98); }

    .segmented{
      background: rgba(255,255,255,.80);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
      box-shadow: var(--shadow-inset);
      display: inline-flex;
      gap: 4px;
    }
    .segmented .btn{
      border-radius: 999px !important;
      border: 0 !important;
      padding: .40rem .75rem;
      font-weight: 800;
      color: var(--muted);
      background: transparent;
    }
    .segmented .btn.active{
      background: rgba(255,255,255,.95);
      color: var(--text);
      box-shadow: 0 8px 16px rgba(0,0,0,.06), var(--shadow-inset);
    }

    .kpi{ display:flex; gap: 12px; align-items:center; }
    .kpi .icon{
      width: 44px; height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,.85);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-inset), var(--shadow-card);
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
    }

    .table-ios{
      overflow: hidden;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow-inset);
    }
    .table thead th{
      font-size: .80rem;
      letter-spacing: .3px;
      color: var(--muted);
      font-weight: 800;
    }
    .table>:not(caption)>*>*{
      background: transparent !important;
      border-color: var(--separator) !important;
      color: var(--text);
    }

    .badge-soft{
      border-radius: 999px;
      padding: .35rem .55rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: var(--text);
      font-weight: 800;
    }
    .status{
      border-radius: 999px;
      padding: .35rem .6rem;
      font-weight: 900;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      display: inline-flex; align-items: center; gap: 6px;
    }
    .dot{ width: 8px; height: 8px; border-radius: 999px; display:inline-block; }
    .status.running{ color: #0b5; border-color: rgba(52,199,89,.35); background: rgba(52,199,89,.12); }
    .status.running .dot{ background: var(--green); }
    .status.starting{ color: #b66a00; border-color: rgba(255,159,10,.45); background: rgba(255,159,10,.14); }
    .status.starting .dot{ background: var(--orange); }
    .status.stopped{ color: rgba(60,60,67,.82); border-color: rgba(142,142,147,.35); background: rgba(142,142,147,.14); }
    .status.stopped .dot{ background: var(--gray); }
    .status.deleting{ color: rgba(255,59,48,.92); border-color: rgba(255,59,48,.30); background: rgba(255,59,48,.10); }
    .status.deleting .dot{ background: var(--red); }

    .notice{
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow-inset);
      padding: 12px 12px;
    }
    .notice.warn{ border-color: rgba(255,159,10,.35); }
    .notice.danger{ border-color: rgba(255,59,48,.30); }
    .notice.info{ border-color: rgba(10,132,255,.28); }

    .hr-soft{ border-top: 1px solid var(--border); opacity: 1; }

    .modal-content{
      background: var(--surface-strong);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
    }

    .smallcaps{ text-transform: uppercase; letter-spacing: .14em; font-size: .72rem; color: var(--muted); font-weight: 800; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill-chip{
      border-radius: 999px;
      padding: .35rem .6rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.8);
      display:inline-flex; align-items:center; gap: 8px;
      font-weight: 800;
    }

    /* Quick actions bar on VM list */
    .quickbar{
      position: sticky;
      top: 14px; /* sits under top padding; works with scroll */
      z-index: 20;
    }
		/* --- Dropdowns should be above everything --- */
	.table-ios { 
	  overflow: visible !important;           /* was hidden */
	}
	.table-ios .table-responsive {
	  overflow: visible !important;           /* was auto/scroll */
	}

	/* Ensure dropdown menus are on top of glass cards/offcanvas */
	.dropdown-menu{
	  z-index: 2000;                          /* higher than most */
	}

	/* optional: if you keep any sticky bars, ensure menus still overlay */
	.quickbar { z-index: 10; }                /* menu is 2000 anyway */
	
	/* User dropdown & any dropdown above glass surfaces */
	.dropdown-menu{
	  z-index: 3000;
	}


	/* =========================
	   THEME: Dark
	   ========================= */

	:root[data-theme="dark"]{
	  --bg:#0b0b0f;

	  --surface:rgba(28,28,30,.72);
	  --surface-strong:rgba(28,28,30,.90);

	  --border:rgba(235,235,245,.12);
	  --separator:rgba(235,235,245,.18);

	  --text:#f5f5f7;
	  --muted:rgba(235,235,245,.68);

	  --shadow-soft:0 12px 32px rgba(0,0,0,.55);
	  --shadow-card:0 10px 22px rgba(0,0,0,.35);
	  --shadow-inset:inset 0 1px 0 rgba(255,255,255,.06);
	}

	/* —Ñ–æ–Ω —Ç–æ–∂–µ –¥–µ–ª–∞–µ–º ‚Äú—Ç–µ–º–Ω–µ–µ‚Äù (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ) */
	:root[data-theme="dark"] body{
	  background:
		radial-gradient(900px 600px at 15% -10%, rgba(10,132,255,.16), transparent 55%),
		radial-gradient(900px 600px at 95% 0%, rgba(52,199,89,.12), transparent 55%),
		radial-gradient(800px 500px at 60% 110%, rgba(255,159,10,.10), transparent 60%),
		var(--bg);
	}

	/* –º–µ–ª–∫–∏–µ –ø—Ä–∞–≤–∫–∏ –¥–ª—è ‚Äú—á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏‚Äù –≤ dark */
	:root[data-theme="dark"] .input-ios,
	:root[data-theme="dark"] .select-ios{
	  background: rgba(44,44,46,.75);
	}

	:root[data-theme="dark"] .btn-ios{
	  background: rgba(44,44,46,.75);
	}

	:root[data-theme="dark"] .table-ios{
	  background: rgba(44,44,46,.55);
	}

	:root[data-theme="dark"] .badge-soft{
	  background: rgba(44,44,46,.70);
	}

	/* Optional: nicer scrollbar colors on chromium */
	:root[data-theme="dark"] *::-webkit-scrollbar-thumb{
	  background: rgba(235,235,245,.22);
	  border-radius: 999px;
	}
	
	/* =========================
	   Dark theme fixes: chips / notices / top buttons
	   ========================= */
	:root[data-theme="dark"] .topbar{
	  background: rgba(28,28,30,.72);
	  border-color: rgba(235,235,245,.10);
	}

	:root[data-theme="dark"] .btn-ios{
	  background: rgba(44,44,46,.55);
	  border-color: rgba(235,235,245,.14);
	  color: var(--text);
	}
	:root[data-theme="dark"] .btn-ios:hover{
	  background: rgba(44,44,46,.68);
	}

	/* Segmented controls (–í—Å–µ/Active/Expiring, Light/Dark) */
	:root[data-theme="dark"] .segmented{
	  background: rgba(44,44,46,.55);
	  border-color: rgba(235,235,245,.14);
	  box-shadow: var(--shadow-inset);
	}
	:root[data-theme="dark"] .segmented .btn{
	  color: rgba(235,235,245,.62);
	}
	:root[data-theme="dark"] .segmented .btn.active{
	  background: rgba(58,58,60,.82);
	  color: rgba(255,255,255,.92);
	  box-shadow: 0 10px 22px rgba(0,0,0,.35), var(--shadow-inset);
	}

	/* Notice cards (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤ offcanvas) */
	:root[data-theme="dark"] .notice{
	  background: rgba(44,44,46,.45);
	  border-color: rgba(235,235,245,.12);
	  color: rgba(255,255,255,.88);
	}
	:root[data-theme="dark"] .notice .text-muted-2{
	  color: rgba(235,235,245,.55) !important;
	}

	/* Keep warn/danger/info tone but not "light gray blocks" */
	:root[data-theme="dark"] .notice.warn{
	  background: rgba(255,159,10,.10);
	  border-color: rgba(255,159,10,.22);
	}
	:root[data-theme="dark"] .notice.danger{
	  background: rgba(255,59,48,.10);
	  border-color: rgba(255,59,48,.20);
	}
	:root[data-theme="dark"] .notice.info{
	  background: rgba(10,132,255,.10);
	  border-color: rgba(10,132,255,.20);
	}

	/* Small chips/badges */
	:root[data-theme="dark"] .badge-soft,
	:root[data-theme="dark"] .pill-chip{
	  background: rgba(44,44,46,.55);
	  border-color: rgba(235,235,245,.14);
	  color: rgba(255,255,255,.88);
	}

	/* Dropdown menu in dark */
	:root[data-theme="dark"] .dropdown-menu{
	  background: rgba(28,28,30,.94);
	  border-color: rgba(235,235,245,.12);
	}
	:root[data-theme="dark"] .dropdown-item{
	  color: rgba(255,255,255,.88);
	}
	:root[data-theme="dark"] .dropdown-item:hover{
	  background: rgba(58,58,60,.65);
	}
	:root[data-theme="dark"] .dropdown-divider{
	  border-color: rgba(235,235,245,.10);
	}
	
	/* =========================
	   Dark theme: placeholders
	   ========================= */
	:root[data-theme="dark"] .input-ios::placeholder,
	:root[data-theme="dark"] .select-ios::placeholder,
	:root[data-theme="dark"] textarea.input-ios::placeholder,
	:root[data-theme="dark"] input.input-ios::placeholder{
	  color: rgba(235,235,245,.55) !important; /* iOS-like placeholder */
	  opacity: 1 !important;                   /* firefox */
	}

	/* Bootstrap's .form-control placeholder fallback */
	:root[data-theme="dark"] .form-control::placeholder{
	  color: rgba(235,235,245,.55) !important;
	  opacity: 1 !important;
	}

	/* For selects (shown value text) */
	:root[data-theme="dark"] .form-select{
	  color: rgba(255,255,255,.88);
	}


  </style>
</head>

<body>
<div class="container-fluid">
  <div class="row g-0">

    <!-- Sidebar -->
    <aside class="col-12 col-lg-2 sidebar p-3">
      <div class="d-flex align-items-center gap-2 mb-3">
        <span class="brand-badge">VM</span>
        <div>
          <div class="fw-bold">VM Console</div>
          <div class="small text-muted-2">–∂–∏–≤–æ–π –¥–µ–º–æ-UI</div>
        </div>
      </div>

      <div class="mb-3">
        <div class="smallcaps mb-2">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="d-grid gap-2">
          <a class="nav-pill active" data-view="dashboard">–î–∞—à–±–æ—Ä–¥</a>
          <a class="nav-pill" data-view="vms">–ú–æ–∏ –í–ú</a>
          <a class="nav-pill" data-view="request">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é</a>
          <a class="nav-pill" data-view="events">–°–æ–±—ã—Ç–∏—è / –õ–æ–≥–∏</a>
          <a class="nav-pill" data-view="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
        </div>
      </div>

      <hr class="hr-soft my-3" />

      <div class="smallcaps mb-2">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="d-grid gap-2">
        <button class="btn btn-ios-primary" id="btnOpenRequest" data-bs-toggle="modal" data-bs-target="#requestVmModal">
          + –ó–∞–ø—Ä–æ—Å–∏—Ç—å –í–ú
        </button>
        <button class="btn btn-ios" id="btnSeed">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë –í–ú</button>
      </div>

      <div class="mt-4 small text-muted-2">
        <div class="p-2" style="border-left:3px solid rgba(10,132,255,.45);">
          –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ –í–ú ‚úÖ
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-12 col-lg-10 p-3 p-lg-4">

      <!-- Topbar -->
      <div class="topbar mb-3">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div>
            <h3 class="mb-1" id="pageTitle">–î–∞—à–±–æ—Ä–¥</h3>
            <div class="text-muted-2" id="pageSubtitle">–ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞, TTL, –∫–≤–æ—Ç—ã, –∑–∞—è–≤–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –í–ú.</div>
          </div>

          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
            <input class="form-control input-ios" id="searchInput" style="min-width: 260px;" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ / IP / —Ç–µ–≥—É‚Ä¶" />

            <div class="segmented" id="segmentedScope">
              <button class="btn active" data-scope="all" type="button">–í—Å–µ</button>
              <button class="btn" data-scope="active" type="button">Active</button>
              <button class="btn" data-scope="expiring" type="button">Expiring</button>
            </div>

            <button class="btn btn-ios position-relative" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifications">
              –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" id="notifCount" style="background: var(--red);">
                0
              </span>
            </button>
			
			<div class="segmented" id="segmentedTheme" title="–¢–µ–º–∞">
			  <button class="btn active" data-theme="light" type="button">Light</button>
			  <button class="btn" data-theme="dark" type="button">Dark</button>
			</div>

            <div class="dropdown">
              <button class="btn btn-ios dropdown-toggle" data-bs-toggle="dropdown">Mykhailo</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" id="btnMockLogin">–°–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (mock)</a></li>
                <li><a class="dropdown-item" id="btnExportEvents">–≠–∫—Å–ø–æ—Ä—Ç —Å–æ–±—ã—Ç–∏–π (mock)</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Views -->
      <section id="viewDashboard">
        <!-- KPI -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-ios p-3">
              <div class="kpi">
                <div class="icon">üü¢</div>
                <div>
                  <div class="text-muted-2 small">–ê–∫—Ç–∏–≤–Ω—ã—Ö –í–ú</div>
                  <div class="fs-4 fw-bold" id="kpiActive">0</div>
                </div>
              </div>
              <div class="mt-3 text-muted-2 small">Running + Starting</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-ios p-3">
              <div class="kpi">
                <div class="icon">‚è≥</div>
                <div>
                  <div class="text-muted-2 small">–ò—Å—Ç–µ–∫–∞—é—Ç —Å–∫–æ—Ä–æ</div>
                  <div class="fs-4 fw-bold" id="kpiExpiring">0</div>
                </div>
              </div>
              <div class="mt-3 text-muted-2 small">&lt; 24 —á–∞—Å–∞</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-ios p-3">
              <div class="kpi">
                <div class="icon">üß†</div>
                <div>
                  <div class="text-muted-2 small">CPU (–∫–≤–æ—Ç–∞)</div>
                  <div class="fs-4 fw-bold"><span id="kpiCpuUsed">0</span> / <span id="kpiCpuQuota">20</span></div>
                </div>
              </div>
              <div class="mt-3">
                <div class="d-flex justify-content-between small text-muted-2">
                  <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</span><span id="kpiCpuPct">0%</span>
                </div>
                <div class="progress mt-1" style="height:10px; border-radius:999px; background: rgba(60,60,67,.10);">
                  <div class="progress-bar" id="cpuProgress" style="width:0%; background: var(--blue); border-radius:999px;"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="card-ios p-3">
              <div class="kpi">
                <div class="icon">üßæ</div>
                <div>
                  <div class="text-muted-2 small">–°–æ–±—ã—Ç–∏–π</div>
                  <div class="fs-4 fw-bold" id="kpiEvents">0</div>
                </div>
              </div>
              <div class="mt-3 text-muted-2 small">–∑–∞ —Å–µ—Å—Å–∏—é</div>
            </div>
          </div>
        </div>

        <!-- Notices (only) -->
        <div class="row g-3">
          <div class="col-12">
            <div class="card-ios p-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-bold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <div class="d-flex gap-2">
                  <button class="btn btn-ios" id="btnGoToVms">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –í–ú</button>
                  <button class="btn btn-ios" id="btnClearNotices">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
              </div>
              <div id="noticeList" class="d-grid gap-2"></div>
              <div class="text-muted-2 small mt-2" id="noticeEmpty" style="display:none;">–ü–æ–∫–∞ —Ç–∏—Ö–æ üôÇ</div>
            </div>
          </div>
        </div>
      </section>

      <!-- VM list view -->
      <section id="viewVms" style="display:none;">

        <!-- Quick actions moved here -->
        <div class="quickbar mb-3">
          <div class="card-ios p-3">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
              <div>
                <div class="fw-bold">–ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
                <div class="small text-muted-2">–í—ã–±–µ—Ä–∏ –í–ú –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Üí –ø—Ä–∏–º–µ–Ω—è–π –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.</div>
              </div>

              <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                <button class="btn btn-ios-primary" data-bs-toggle="modal" data-bs-target="#requestVmModal">+ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –í–ú</button>
                <button class="btn btn-ios" id="btnBulkExtend">–ü—Ä–æ–¥–ª–∏—Ç—å TTL (+24—á)</button>
                <button class="btn btn-ios" id="btnBulkRestart">Restart</button>
                <button class="btn btn-ios" id="btnBulkStop">Stop</button>
                <button class="btn btn-ios" id="btnBulkDelete" style="border-color: rgba(255,59,48,.25); color: var(--red);">Delete</button>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
              <span class="pill-chip"><span>–í—ã–±—Ä–∞–Ω–æ:</span> <span id="selectedCount" class="mono">0</span></span>
              <span class="pill-chip"><span>–§–∏–ª—å—Ç—Ä:</span> <span class="mono" id="scopeChip">all</span></span>
              <span class="text-muted-2 small ms-1">–°–æ–≤–µ—Ç: TTL-—Å—Ä–æ—á–Ω—ã–µ –≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—Ö—É.</span>
            </div>
          </div>
        </div>

        <!-- Table card -->
        <div class="card-ios p-3">
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-2">
            <div>
              <div class="fw-bold">–ú–æ–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã</div>
              <div class="small text-muted-2">–§–∏–ª—å—Ç—Ä—ã, TTL, –¥–µ–π—Å—Ç–≤–∏—è –∏ –¥–µ—Ç–∞–ª–∏ –í–ú (mock).</div>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <select class="form-select select-ios form-select-sm" id="statusFilter" style="width: 170px;">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="Running">Running</option>
                <option value="Starting">Starting</option>
                <option value="Stopped">Stopped</option>
                <option value="Deleting">Deleting</option>
              </select>
              <select class="form-select select-ios form-select-sm" id="projectFilter" style="width: 170px;">
                <option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
              </select>
              <button class="btn btn-ios" id="btnExportVms">–≠–∫—Å–ø–æ—Ä—Ç (mock)</button>
            </div>
          </div>

          <div class="table-ios">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th style="width:44px;"><input type="checkbox" class="form-check-input" id="selectAll"></th>
                    <th>–ò–º—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>IP / DNS</th>
                    <th>–ö–æ–Ω—Ñ–∏–≥</th>
                    <th>TTL</th>
                    <th>–£–¥–∞–ª–µ–Ω–∏–µ</th>
                    <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                  </tr>
                </thead>
                <tbody id="vmTableBody"></tbody>
              </table>
            </div>
          </div>

          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-3 small text-muted-2">
            <div>
              –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="shownCount" class="mono">0</span> / <span id="totalCount" class="mono">0</span>
              <span class="ms-2">Page <span id="pageIndex" class="mono">1</span> / <span id="pageTotal" class="mono">1</span></span>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-ios" id="btnPrevPage">–ù–∞–∑–∞–¥</button>
              <button class="btn btn-ios" id="btnNextPage">–í–ø–µ—Ä—ë–¥</button>
            </div>
          </div>
        </div>
      </section>

      <section id="viewRequest" style="display:none;">
        <div class="card-ios p-4">
          <div class="fw-bold mb-1">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é –í–ú</div>
          <div class="text-muted-2 mb-3">–û—Ç–∫—Ä–æ–µ–º –º–æ–¥–∞–ª–∫—É ‚Äú–∫–∞–∫ –±—É–¥—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞‚Äù.</div>
          <button class="btn btn-ios-primary" data-bs-toggle="modal" data-bs-target="#requestVmModal">–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
      </section>

      <section id="viewEvents" style="display:none;">
        <div class="card-ios p-3">
          <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
            <div>
              <div class="fw-bold">–°–æ–±—ã—Ç–∏—è</div>
              <div class="small text-muted-2">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –∑–∞ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é.</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-ios" id="btnClearEvents">–û—á–∏—Å—Ç–∏—Ç—å</button>
              <button class="btn btn-ios" id="btnSeedEvents">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ</button>
            </div>
          </div>

          <div class="table-ios">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th style="width: 160px;">–í—Ä–µ–º—è</th>
                    <th>–°–æ–±—ã—Ç–∏–µ</th>
                    <th style="width: 220px;">VM</th>
                    <th style="width: 140px;">–°—Ç–∞—Ç—É—Å</th>
                  </tr>
                </thead>
                <tbody id="eventsTableBody"></tbody>
              </table>
            </div>
          </div>

          <div class="small text-muted-2 mt-2">–ö–ª–∏–∫–∞–π –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –í–ú ‚Äî —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç —Ç—É—Ç.</div>
        </div>
      </section>

      <section id="viewSettings" style="display:none;">
        <div class="card-ios p-4">
          <div class="fw-bold mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (mock)</div>
          <div class="text-muted-2 mb-3">–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.</div>

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="p-3 card-ios">
                <div class="fw-bold mb-2">–ü–æ–≤–µ–¥–µ–Ω–∏–µ</div>

                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="optAutoRefresh" checked>
                  <label class="form-check-label" for="optAutoRefresh">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ 5—Å, mock)</label>
                </div>

                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="optToasts" checked>
                  <label class="form-check-label" for="optToasts">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                </div>

                <div class="text-muted-2 small">–í–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ–º–æ.</div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="p-3 card-ios">
                <div class="fw-bold mb-2">–ö–≤–æ—Ç—ã (mock)</div>

                <label class="form-label text-muted-2">CPU quota</label>
                <input type="range" class="form-range" id="quotaCpu" min="4" max="64" value="20">

                <div class="d-flex justify-content-between small text-muted-2">
                  <span>4</span><span class="mono" id="quotaCpuValue">20</span><span>64</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Offcanvas Notifications -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications" aria-labelledby="offcanvasNotificationsLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasNotificationsLabel">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="d-flex gap-2 mb-2">
      <button class="btn btn-ios" id="btnMarkAllRead">–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º</button>
      <button class="btn btn-ios" id="btnClearNotifications">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div id="notificationsList" class="d-grid gap-2"></div>
    <div class="text-muted-2 small mt-2" id="notificationsEmpty" style="display:none;">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</div>
  </div>
</div>

<!-- Request VM Modal -->
<div class="modal fade" id="requestVmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-0">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label text-muted-2">–ò–º—è –í–ú</label>
            <input class="form-control input-ios" id="reqName" placeholder="vm-dev-04" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label text-muted-2">–ü—Ä–æ–µ–∫—Ç</label>
            <input class="form-control input-ios" id="reqProject" placeholder="dev / api" />
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label text-muted-2">–®–∞–±–ª–æ–Ω</label>
            <select class="form-select select-ios" id="reqTemplate">
              <option>Ubuntu 24.04 + Docker</option>
              <option>Windows Server 2022</option>
              <option>Ubuntu 22.04 Minimal</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label text-muted-2">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ (TTL)</label>
            <select class="form-select select-ios" id="reqTtlHours">
              <option value="8">8 —á–∞—Å–æ–≤</option>
              <option value="24" selected>24 —á–∞—Å–∞</option>
              <option value="72">3 –¥–Ω—è</option>
              <option value="168">7 –¥–Ω–µ–π</option>
            </select>
            <div class="form-text text-muted-2">–ü–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL –í–ú –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (mock).</div>
          </div>

          <div class="col-12">
            <label class="form-label text-muted-2">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</label>
            <div class="row g-2">
              <div class="col-4">
                <select class="form-select select-ios" id="reqCpu">
                  <option value="1">1 vCPU</option>
                  <option value="2" selected>2 vCPU</option>
                  <option value="4">4 vCPU</option>
                  <option value="8">8 vCPU</option>
                </select>
              </div>
              <div class="col-4">
                <select class="form-select select-ios" id="reqRam">
                  <option value="2">2 GB RAM</option>
                  <option value="4" selected>4 GB RAM</option>
                  <option value="8">8 GB RAM</option>
                  <option value="16">16 GB RAM</option>
                </select>
              </div>
              <div class="col-4">
                <select class="form-select select-ios" id="reqDisk">
                  <option value="40">40 GB Disk</option>
                  <option value="60" selected>60 GB Disk</option>
                  <option value="80">80 GB Disk</option>
                  <option value="120">120 GB Disk</option>
                </select>
              </div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label text-muted-2">SSH key (–ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á, mock)</label>
            <input class="form-control input-ios" id="reqSsh" placeholder="ssh-ed25519 AAAA... user@host" />
          </div>

          <div class="col-12">
            <label class="form-label text-muted-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea class="form-control input-ios" id="reqComment" rows="3" placeholder="–î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–∞ –í–ú, –≤–ª–∞–¥–µ–ª–µ—Ü, —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∏–∫–µ—Ç‚Ä¶"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-ios" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-ios-primary" id="btnSubmitRequest">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
      </div>
    </div>
  </div>
</div>

<!-- VM Details Modal -->
<div class="modal fade" id="vmDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <div>
          <h5 class="modal-title mb-0" id="vmDetailsTitle">VM</h5>
          <div class="small text-muted-2" id="vmDetailsSubtitle"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-0">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card-ios p-3">
              <div class="fw-bold mb-2">Overview</div>
              <div class="d-grid gap-1 small">
                <div><span class="text-muted-2">ID:</span> <span class="mono" id="vmDetailsId"></span></div>
                <div><span class="text-muted-2">Project:</span> <span id="vmDetailsProject"></span></div>
                <div><span class="text-muted-2">Template:</span> <span id="vmDetailsTemplate"></span></div>
                <div><span class="text-muted-2">IP:</span> <span class="mono" id="vmDetailsIp"></span></div>
                <div><span class="text-muted-2">DNS:</span> <span class="mono" id="vmDetailsDns"></span></div>
                <div><span class="text-muted-2">Created:</span> <span id="vmDetailsCreated"></span></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card-ios p-3">
              <div class="fw-bold mb-2">TTL</div>
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-muted-2 small">–£–¥–∞–ª–µ–Ω–∏–µ</div>
                  <div class="fw-bold" id="vmDetailsDeleteAt"></div>
                </div>
                <div class="text-end">
                  <div class="text-muted-2 small">–û—Å—Ç–∞–ª–æ—Å—å</div>
                  <div class="fw-bold" id="vmDetailsTtlLeft"></div>
                </div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-ios" id="btnDetailsExtend">+24—á</button>
                <button class="btn btn-ios" id="btnDetailsShorten">-2—á</button>
                <button class="btn btn-ios" id="btnDetailsRefresh">Refresh</button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card-ios p-3">
              <div class="fw-bold mb-2">Actions</div>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-ios" id="btnDetailsStart">Start</button>
                <button class="btn btn-ios" id="btnDetailsStop">Stop</button>
                <button class="btn btn-ios" id="btnDetailsRestart">Restart</button>
                <button class="btn btn-ios" id="btnDetailsCopySsh">Copy SSH</button>
                <button class="btn btn-ios" id="btnDetailsDelete" style="border-color: rgba(255,59,48,.25); color: var(--red);">Delete</button>
              </div>
              <div class="text-muted-2 small mt-2">Mock-–æ–ø–µ—Ä–∞—Ü–∏–∏: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è, —Å–æ–±—ã—Ç–∏—è –ø–∏—à—É—Ç—Å—è.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-ios" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-0" id="confirmBody">‚Ä¶</div>
      <div class="modal-footer border-0">
        <button class="btn btn-ios" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-ios-primary" id="confirmOk">–û–∫</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="toastHost" class="d-grid gap-2"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const uid = () => Math.random().toString(16).slice(2,10) + "-" + Math.random().toString(16).slice(2,6);

  const fmtDate = (d) => {
    const pad = (n) => String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  const hoursBetween = (a,b) => (b.getTime() - a.getTime()) / 36e5;
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  function setActiveNav(view){
    $$(".nav-pill").forEach(x => x.classList.toggle("active", x.dataset.view === view));
  }

  function setView(view){
    const views = ["dashboard","vms","request","events","settings"];
    views.forEach(v => {
      const el = $("#view" + v[0].toUpperCase() + v.slice(1));
      if (!el) return;
      el.style.display = (v === view) ? "" : "none";
    });
    setActiveNav(view);
    const titleMap = {
      dashboard: ["–î–∞—à–±–æ—Ä–¥","–°–≤–æ–¥–∫–∞: KPI –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."],
      vms: ["–ú–æ–∏ –í–ú","–°–ø–∏—Å–æ–∫, —Ñ–∏–ª—å—Ç—Ä—ã, TTL –∏ –±—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏."],
      request: ["–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é","–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –í–ú (mock)"],
      events: ["–°–æ–±—ã—Ç–∏—è / –õ–æ–≥–∏","–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –∫–ª–∏–∫–∞–µ—à—å."],
      settings: ["–ù–∞—Å—Ç—Ä–æ–π–∫–∏","–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –∏ –∫–≤–æ—Ç—ã (mock)."]
    };
    $("#pageTitle").textContent = titleMap[view][0];
    $("#pageSubtitle").textContent = titleMap[view][1];
    state.view = view;
    renderAll();
  }

  function toast(message, kind="info"){
    if (!$("#optToasts")?.checked) return;
    const bg = {
      info: "rgba(255,255,255,.92)",
      ok: "rgba(52,199,89,.18)",
      warn: "rgba(255,159,10,.18)",
      danger: "rgba(255,59,48,.16)"
    }[kind] || "rgba(255,255,255,.92)";

    const border = {
      info: "rgba(60,60,67,.18)",
      ok: "rgba(52,199,89,.30)",
      warn: "rgba(255,159,10,.35)",
      danger: "rgba(255,59,48,.28)"
    }[kind] || "rgba(60,60,67,.18)";

    const el = document.createElement("div");
    el.className = "toast show";
    el.setAttribute("role","alert");
    el.style.borderRadius = "18px";
    el.style.background = bg;
    el.style.border = `1px solid ${border}`;
    el.style.boxShadow = "0 10px 30px rgba(0,0,0,.10)";
    el.innerHTML = `
      <div class="toast-body d-flex align-items-start justify-content-between gap-2">
        <div>${message}</div>
        <button type="button" class="btn-close" aria-label="Close"></button>
      </div>
    `;
    $("#toastHost").appendChild(el);
    el.querySelector(".btn-close").addEventListener("click", () => el.remove());
    setTimeout(() => el.remove(), 3200);
  }

  function addEvent(type, vmName="", status=""){
    const now = new Date();
    state.events.unshift({ id: uid(), at: now, type, vmName, status });
    if (state.events.length > 200) state.events.length = 200;
    renderKpis();
    if (state.view === "events") renderEvents();
  }

  function addNotification(kind, text, vmId=null){
    state.notifications.unshift({ id: uid(), kind, text, vmId, read:false, at: new Date() });
    renderNotifications();
    renderNotices();
  }

  function computeTtl(vm){
    const now = new Date();
    const leftHrs = hoursBetween(now, vm.deleteAt);
    return { leftHrs, expiring: leftHrs <= 24 && leftHrs > 0, expired: leftHrs <= 0 };
  }

  function statusBadge(status){
    const map = {
      Running: ["running", "Running"],
      Starting: ["starting", "Starting"],
      Stopped: ["stopped", "Stopped"],
      Deleting: ["deleting", "Deleting"]
    };
    const [cls, label] = map[status] || ["stopped", status];
    return `<span class="status ${cls}"><span class="dot"></span>${label}</span>`;
  }

  function ttlLabel(vm){
    const { leftHrs, expired } = computeTtl(vm);
    if (expired) return `<span style="color: var(--red); font-weight: 900;">–∏—Å—Ç—ë–∫</span>`;
    if (leftHrs < 1) return `<span style="color: var(--red); font-weight: 900;">~ ${Math.max(1, Math.round(leftHrs*60))}–º</span>`;
    if (leftHrs <= 24) return `<span style="color: var(--orange); font-weight: 900;">~ ${Math.round(leftHrs)}—á</span>`;
    const days = leftHrs / 24;
    return `<span style="font-weight: 900;">~ ${days >= 2 ? Math.round(days) : days.toFixed(1)}–¥</span>`;
  }

  function sshCmd(vm){
    const user = vm.template.includes("Windows") ? "Administrator" : "ubuntu";
    return `ssh ${user}@${vm.ip || vm.dns || "0.0.0.0"}`;
  }

  function ensureProjectsInFilter(){
    const set = new Set(state.vms.map(v => v.project));
    const sel = $("#projectFilter");
    const current = sel.value;
    sel.innerHTML = `<option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>` + [...set].sort().map(p => `<option value="${p}">${p}</option>`).join("");
    if ([...set, "all"].includes(current)) sel.value = current;
  }

  // ===== State =====
  const state = {
    view: "dashboard",
    scope: "all",
    search: "",
    statusFilter: "all",
    projectFilter: "all",
    pageIndex: 1,
    pageSize: 7,
    selected: new Set(),
    activeVmId: null,
    events: [],
    notifications: [],
    vms: []
  };
  
	 // ===== Theme =====
	function applyTheme(theme){
	  const t = (theme === "dark") ? "dark" : "light";
	  document.documentElement.setAttribute("data-theme", t);
	  localStorage.setItem("vmconsole.theme", t);

	  // segmented UI
	  const seg = document.getElementById("segmentedTheme");
	  if (seg){
		seg.querySelectorAll(".btn").forEach(b => {
		  b.classList.toggle("active", b.dataset.theme === t);
		});
	  }
	}

	function loadTheme(){
	  const saved = localStorage.getItem("vmconsole.theme");
	  if (saved === "dark" || saved === "light") return saved;
	  // default: follow OS preference
	  return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
	}
	
	// Theme segmented handler
document.getElementById("segmentedTheme")?.addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-theme]");
  if (!btn) return;
  applyTheme(btn.dataset.theme);
});

  // ===== Seed data =====
  function seedVms(n=6){
    const now = new Date();
    const templates = ["Ubuntu 24.04 + Docker","Ubuntu 22.04 Minimal","Windows Server 2022"];
    const projects = ["dev","ci","demo","sandbox"];
    const statuses = ["Running","Running","Starting","Stopped"];
    for (let i=0;i<n;i++){
      const id = uid();
      const project = projects[Math.floor(Math.random()*projects.length)];
      const template = templates[Math.floor(Math.random()*templates.length)];
      const status = statuses[Math.floor(Math.random()*statuses.length)];
      const cpu = [1,2,2,4,4,8][Math.floor(Math.random()*6)];
      const ram = [2,4,4,8,16][Math.floor(Math.random()*5)];
      const disk = [40,60,80,120][Math.floor(Math.random()*4)];
      const createdAt = new Date(now.getTime() - Math.floor(Math.random()*48)*36e5);
      const ttlHrs = [6,12,24,48,72,120][Math.floor(Math.random()*6)];
      const deleteAt = new Date(createdAt.getTime() + ttlHrs*36e5);
      const ip = (status === "Starting") ? "" : `10.10.${Math.floor(Math.random()*10)}.${Math.floor(10+Math.random()*200)}`;
      const name = `vm-${project}-${String(Math.floor(Math.random()*90)+10).padStart(2,"0")}`;
      const dns = `${name}.local`;

      state.vms.push({
        id, name, project, template,
        status,
        cpu, ram, disk,
        ip, dns,
        tags: [project, template.includes("Windows") ? "win" : "linux", status.toLowerCase()],
        createdAt, deleteAt
      });
    }
    ensureProjectsInFilter();
    addEvent("Seed VMs", "", "");
    toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${n} VM (mock)`, "ok");
  }

  seedVms(8);

  state.notifications.push({
    id: uid(), kind:"info", text:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ —Å–ø–∏—Å–∫–µ –í–ú üôÇ", vmId:null, read:false, at:new Date()
  });

  function refreshAutoNotices(){
    state.notifications = state.notifications.filter(n => n.kind === "info" && n.text.startsWith("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å"));
    const exp = state.vms
      .filter(v => computeTtl(v).expiring && v.status !== "Deleting")
      .sort((a,b)=>a.deleteAt-b.deleteAt)
      .slice(0,5);

    exp.forEach(v=>{
      const left = computeTtl(v).leftHrs;
      addNotification(left <= 6 ? "danger" : "warn", `${v.name} –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ~ ${Math.max(1, Math.round(left))}—á`, v.id);
    });

    $("#notifCount").textContent = String(state.notifications.filter(n=>!n.read).length);
  }

  // ===== Filtering / pagination =====
  function getFilteredVms(){
    const q = state.search.trim().toLowerCase();
    let list = [...state.vms];

    if (state.scope === "active"){
      list = list.filter(v => ["Running","Starting"].includes(v.status));
    } else if (state.scope === "expiring"){
      list = list.filter(v => computeTtl(v).expiring);
    }

    if (state.statusFilter !== "all") list = list.filter(v => v.status === state.statusFilter);
    if (state.projectFilter !== "all") list = list.filter(v => v.project === state.projectFilter);

    if (q){
      list = list.filter(v => {
        const hay = [v.name,v.ip,v.dns,v.project,v.template,(v.tags||[]).join(" ")].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    list.sort((a,b)=>{
      const la = computeTtl(a).leftHrs;
      const lb = computeTtl(b).leftHrs;
      return la - lb || a.name.localeCompare(b.name);
    });

    return list;
  }

  function getPaged(list){
    const total = list.length;
    const pageTotal = Math.max(1, Math.ceil(total / state.pageSize));
    state.pageIndex = clamp(state.pageIndex, 1, pageTotal);
    const start = (state.pageIndex - 1) * state.pageSize;
    return { total, pageTotal, items: list.slice(start, start + state.pageSize) };
  }

  // ===== Render =====
  function renderKpis(){
    const active = state.vms.filter(v => ["Running","Starting"].includes(v.status)).length;
    const expiring = state.vms.filter(v => computeTtl(v).expiring).length;
    const cpuUsed = state.vms
      .filter(v => ["Running","Starting"].includes(v.status))
      .reduce((s,v)=>s+v.cpu,0);

    const cpuQuota = Number($("#quotaCpu")?.value ?? 20);

    $("#kpiActive").textContent = String(active);
    $("#kpiExpiring").textContent = String(expiring);
    $("#kpiCpuUsed").textContent = String(cpuUsed);
    $("#kpiCpuQuota").textContent = String(cpuQuota);

    const pct = cpuQuota ? Math.round((cpuUsed/cpuQuota)*100) : 0;
    $("#kpiCpuPct").textContent = `${clamp(pct,0,999)}%`;
    $("#cpuProgress").style.width = `${clamp(pct,0,100)}%`;

    $("#kpiEvents").textContent = String(state.events.length);

    refreshAutoNotices();
  }

  function renderNotices(){
    const list = state.notifications.filter(n=>!n.read).slice(0,3);
    const host = $("#noticeList");
    host.innerHTML = "";

    if (list.length === 0){
      $("#noticeEmpty").style.display = "";
      return;
    }
    $("#noticeEmpty").style.display = "none";

    list.forEach(n=>{
      const cls = n.kind === "danger" ? "danger" : (n.kind === "warn" ? "warn" : "info");
      const el = document.createElement("div");
      el.className = `notice ${cls}`;
      el.innerHTML = `<div class="d-flex justify-content-between gap-2">
        <div>${n.text}</div>
        <div class="text-muted-2 small mono">${fmtDate(n.at)}</div>
      </div>`;
      el.addEventListener("click", () => {
        n.read = true;
        toast("–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ", "ok");
        renderNotifications();
        renderNotices();
      });
      host.appendChild(el);
    });

    $("#notifCount").textContent = String(state.notifications.filter(n=>!n.read).length);
  }

  function renderNotifications(){
    const host = $("#notificationsList");
    host.innerHTML = "";

    if (state.notifications.length === 0){
      $("#notificationsEmpty").style.display = "";
      $("#notifCount").textContent = "0";
      return;
    }
    $("#notificationsEmpty").style.display = "none";

    state.notifications.slice(0,30).forEach(n=>{
      const cls = n.kind === "danger" ? "danger" : (n.kind === "warn" ? "warn" : "info");
      const el = document.createElement("div");
      el.className = `notice ${cls}`;
      el.innerHTML = `
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-bold" style="font-size:.95rem;">${n.read ? "‚úì" : "‚Ä¢"} ${n.text}</div>
            <div class="small text-muted-2">
              <span class="mono">${fmtDate(n.at)}</span>
              ${n.vmId ? ` ¬∑ <a href="#" class="text-decoration-none" data-open-vm="${n.vmId}">–û—Ç–∫—Ä—ã—Ç—å VM</a>` : ""}
            </div>
          </div>
          <button class="btn btn-ios" style="padding:.30rem .65rem;" data-mark-read="${n.id}">Read</button>
        </div>
      `;
      host.appendChild(el);
    });

    $$("[data-mark-read]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        const id = btn.getAttribute("data-mark-read");
        const n = state.notifications.find(x=>x.id===id);
        if (!n) return;
        n.read = true;
        renderNotifications();
        renderNotices();
      });
    });

    $$("[data-open-vm]").forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        openVmDetails(a.getAttribute("data-open-vm"));
      });
    });

    $("#notifCount").textContent = String(state.notifications.filter(n=>!n.read).length);
  }

  function isAllVisibleSelected(){
    const visible = getPaged(getFilteredVms()).items.map(v=>v.id);
    return visible.length > 0 && visible.every(id => state.selected.has(id));
  }

  function renderVmTable(){
    $("#scopeChip").textContent = state.scope;

    const list = getFilteredVms();
    const { total, pageTotal, items } = getPaged(list);

    $("#totalCount").textContent = String(state.vms.length);
    $("#shownCount").textContent = String(total);
    $("#pageIndex").textContent = String(state.pageIndex);
    $("#pageTotal").textContent = String(pageTotal);

    const body = $("#vmTableBody");
    body.innerHTML = "";

    const existingIds = new Set(state.vms.map(v=>v.id));
    state.selected = new Set([...state.selected].filter(id => existingIds.has(id)));
    $("#selectedCount").textContent = String(state.selected.size);

    items.forEach(vm=>{
      const ttl = computeTtl(vm);
      if (ttl.expired && vm.status !== "Deleting"){
        vm.status = "Deleting";
        addEvent("TTL expired ‚Üí deleting", vm.name, vm.status);
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="checkbox" class="form-check-input" data-select="${vm.id}" ${state.selected.has(vm.id) ? "checked" : ""}></td>
        <td class="clickable" data-open="${vm.id}">
          <div class="fw-semibold">${vm.name}</div>
          <div class="small text-muted-2">tags: ${(vm.tags||[]).join(", ")}</div>
        </td>
        <td>${statusBadge(vm.status)}</td>
        <td>
          <div class="fw-semibold mono">${vm.ip || "‚Äî"}</div>
          <div class="small text-muted-2 mono">${vm.dns}</div>
        </td>
        <td>
          <span class="badge-soft">${vm.cpu} vCPU</span>
          <span class="badge-soft">${vm.ram} GB</span>
          <span class="badge-soft">${vm.disk} GB</span>
        </td>
        <td>
          <div class="small text-muted-2">–æ—Å—Ç–∞–ª–æ—Å—å</div>
          <div class="fw-semibold">${ttlLabel(vm)}</div>
        </td>
        <td>
          <div class="small text-muted-2">–∞–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ</div>
          <div class="fw-semibold">${fmtDate(vm.deleteAt)}</div>
        </td>
        <td class="text-end">
          <div class="btn-group">
            <button class="btn btn-ios" data-open="${vm.id}" style="padding:.35rem .75rem;">Open</button>
            <button class="btn btn-ios dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" style="padding:.35rem .6rem;"></button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" data-action="extend" data-id="${vm.id}">–ü—Ä–æ–¥–ª–∏—Ç—å TTL (+24—á)</a></li>
              <li><a class="dropdown-item" href="#" data-action="restart" data-id="${vm.id}">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</a></li>
              <li><a class="dropdown-item" href="#" data-action="${vm.status === "Stopped" ? "start" : "stop"}" data-id="${vm.id}">
                ${vm.status === "Stopped" ? "–ó–∞–ø—É—Å—Ç–∏—Ç—å" : "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"}
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" data-action="copyssh" data-id="${vm.id}">Copy SSH</a></li>
              <li><a class="dropdown-item" href="#" data-action="delete" data-id="${vm.id}" style="color: var(--red);">–£–¥–∞–ª–∏—Ç—å</a></li>
            </ul>
          </div>
        </td>
      `;
      body.appendChild(row);
    });

    $$("[data-select]").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const id = cb.getAttribute("data-select");
        cb.checked ? state.selected.add(id) : state.selected.delete(id);
        $("#selectedCount").textContent = String(state.selected.size);
        $("#selectAll").checked = isAllVisibleSelected();
      });
    });

    $$("[data-open]").forEach(el=>{
      el.addEventListener("click", ()=>{
        openVmDetails(el.getAttribute("data-open"));
      });
    });

    $$("[data-action]").forEach(a=>{
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        runAction(a.getAttribute("data-action"), [a.getAttribute("data-id")]);
      });
    });

    $("#selectAll").checked = isAllVisibleSelected();
  }

  function renderEvents(){
    const body = $("#eventsTableBody");
    body.innerHTML = "";
    const items = state.events.slice(0,60);
    if (items.length === 0){
      body.innerHTML = `<tr><td colspan="4" class="text-muted-2">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π.</td></tr>`;
      return;
    }
    items.forEach(e=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${fmtDate(e.at)}</td>
        <td>${e.type}</td>
        <td class="mono">${e.vmName || "‚Äî"}</td>
        <td>${e.status ? statusBadge(e.status) : "‚Äî"}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderAll(){
    renderKpis();
    renderNotices();
    renderNotifications();
    ensureProjectsInFilter();
    if (state.view === "vms") renderVmTable();
    if (state.view === "events") renderEvents();
  }

  // ===== Actions =====
  function confirm(title, body, onOk){
    $("#confirmTitle").textContent = title;
    $("#confirmBody").textContent = body;
    const modal = new bootstrap.Modal($("#confirmModal"));
    const okBtn = $("#confirmOk");
    const handler = () => {
      okBtn.removeEventListener("click", handler);
      modal.hide();
      onOk();
    };
    okBtn.addEventListener("click", handler);
    modal.show();
  }

  function runAction(action, ids){
    const vms = ids.map(id => state.vms.find(v=>v.id===id)).filter(Boolean);
    if (vms.length === 0){
      toast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –í–ú", "warn");
      return;
    }

    const act = {
      extend: () => vms.forEach(vm => { vm.deleteAt = new Date(vm.deleteAt.getTime() + 24*36e5); addEvent("Extend TTL +24h", vm.name, vm.status); }),
      restart: () => vms.forEach(vm => { addEvent("Restart VM", vm.name, vm.status); }),
      stop: () => vms.forEach(vm => { vm.status = "Stopped"; addEvent("Stop VM", vm.name, vm.status); }),
      start: () => vms.forEach(vm => { vm.status = "Starting"; addEvent("Start VM", vm.name, vm.status); }),
      delete: () => vms.forEach(vm => { vm.status = "Deleting"; addEvent("Delete VM (requested)", vm.name, vm.status); }),
      copyssh: () => vms.forEach(vm => copyToClipboard(sshCmd(vm), `SSH —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –¥–ª—è ${vm.name}`))
    }[action];

    if (!act) return;

    if (action === "delete"){
      confirm("–£–¥–∞–ª–∏—Ç—å –í–ú?", `–£–¥–∞–ª–∏—Ç—å: ${vms.map(v=>v.name).join(", ")} (mock)`, ()=>{
        act();
        setTimeout(()=>{
          const idsSet = new Set(vms.map(v=>v.id));
          state.vms = state.vms.filter(v => !idsSet.has(v.id));
          state.selected = new Set([...state.selected].filter(id => !idsSet.has(id)));
          addEvent("VM deleted (mock)", vms[0].name, "");
          toast("–í–ú —É–¥–∞–ª–µ–Ω—ã (mock)", "danger");
          renderAll();
        }, 1200);
      });
      return;
    }

    if (action === "start"){
      act();
      setTimeout(()=>{
        vms.forEach(vm => { if (vm.status === "Starting") { vm.status = "Running"; vm.ip = vm.ip || `10.10.${Math.floor(Math.random()*10)}.${Math.floor(10+Math.random()*200)}`; addEvent("VM is Running", vm.name, vm.status); }});
        renderAll();
      }, 1200);
      toast("Start requested (mock)", "ok");
      renderAll();
      return;
    }

    if (action === "extend"){ act(); toast("TTL –ø—Ä–æ–¥–ª—ë–Ω (+24—á)", "ok"); renderAll(); return; }
    if (action === "stop"){ act(); toast("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "warn"); renderAll(); return; }
    if (action === "restart"){ act(); toast("Restart (mock)", "info"); renderAll(); return; }
    if (action === "copyssh"){ act(); renderAll(); return; }

    renderAll();
  }

  async function copyToClipboard(text, okMsg="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"){
    try{ await navigator.clipboard.writeText(text); toast(okMsg, "ok"); }
    catch{
      const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy"); ta.remove(); toast(okMsg, "ok");
    }
  }

  function openVmDetails(vmId){
    const vm = state.vms.find(v=>v.id===vmId);
    if (!vm) return;

    $("#vmDetailsTitle").textContent = vm.name;
    $("#vmDetailsSubtitle").textContent = `${vm.project} ¬∑ ${vm.template} ¬∑ ${vm.cpu}vCPU/${vm.ram}GB/${vm.disk}GB`;
    $("#vmDetailsId").textContent = vm.id;
    $("#vmDetailsProject").textContent = vm.project;
    $("#vmDetailsTemplate").textContent = vm.template;
    $("#vmDetailsIp").textContent = vm.ip || "‚Äî";
    $("#vmDetailsDns").textContent = vm.dns;
    $("#vmDetailsCreated").textContent = fmtDate(vm.createdAt);

    const updTtl = () => {
      $("#vmDetailsDeleteAt").textContent = fmtDate(vm.deleteAt);
      const { leftHrs, expired } = computeTtl(vm);
      $("#vmDetailsTtlLeft").textContent = expired ? "–∏—Å—Ç—ë–∫" : (leftHrs < 1 ? `~ ${Math.max(1, Math.round(leftHrs*60))}–º` : `~ ${Math.round(leftHrs)}—á`);
    };
    updTtl();

    $("#btnDetailsExtend").onclick = () => { runAction("extend",[vmId]); updTtl(); };
    $("#btnDetailsShorten").onclick = () => { vm.deleteAt = new Date(vm.deleteAt.getTime() - 2*36e5); addEvent("Shorten TTL -2h", vm.name, vm.status); toast("TTL —É–º–µ–Ω—å—à–µ–Ω (-2—á)", "warn"); renderAll(); updTtl(); };
    $("#btnDetailsRefresh").onclick = () => { updTtl(); toast("–û–±–Ω–æ–≤–ª–µ–Ω–æ", "info"); };

    $("#btnDetailsStart").onclick = () => runAction("start",[vmId]);
    $("#btnDetailsStop").onclick = () => runAction("stop",[vmId]);
    $("#btnDetailsRestart").onclick = () => runAction("restart",[vmId]);
    $("#btnDetailsCopySsh").onclick = () => runAction("copyssh",[vmId]);
    $("#btnDetailsDelete").onclick = () => runAction("delete",[vmId]);

    new bootstrap.Modal($("#vmDetailsModal")).show();
  }

  // ===== Handlers =====
  $$(".nav-pill").forEach(a=>{
    a.addEventListener("click", ()=>{
      const view = a.dataset.view;
      setView(view);
      if (view === "request") new bootstrap.Modal($("#requestVmModal")).show();
    });
  });

  $("#segmentedScope").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-scope]");
    if (!btn) return;
    $$("#segmentedScope .btn").forEach(b=>b.classList.toggle("active", b===btn));
    state.scope = btn.dataset.scope;
    state.pageIndex = 1;
    renderAll();
  });

  $("#searchInput").addEventListener("input", ()=>{
    state.search = $("#searchInput").value;
    state.pageIndex = 1;
    renderAll();
    if (state.view === "vms") renderVmTable();
  });

  $("#statusFilter").addEventListener("change", ()=>{
    state.statusFilter = $("#statusFilter").value;
    state.pageIndex = 1;
    renderVmTable();
  });
  $("#projectFilter").addEventListener("change", ()=>{
    state.projectFilter = $("#projectFilter").value;
    state.pageIndex = 1;
    renderVmTable();
  });

  $("#selectAll").addEventListener("change", ()=>{
    const visible = getPaged(getFilteredVms()).items.map(v=>v.id);
    if ($("#selectAll").checked) visible.forEach(id => state.selected.add(id));
    else visible.forEach(id => state.selected.delete(id));
    $("#selectedCount").textContent = String(state.selected.size);
    renderVmTable();
  });

  $("#btnPrevPage").addEventListener("click", ()=>{ state.pageIndex--; renderVmTable(); });
  $("#btnNextPage").addEventListener("click", ()=>{ state.pageIndex++; renderVmTable(); });

  // bulk actions (now only on VM list)
  const getSelectedIds = () => [...state.selected];
  $("#btnBulkExtend").addEventListener("click", ()=> runAction("extend", getSelectedIds()));
  $("#btnBulkRestart").addEventListener("click", ()=> runAction("restart", getSelectedIds()));
  $("#btnBulkStop").addEventListener("click", ()=> runAction("stop", getSelectedIds()));
  $("#btnBulkDelete").addEventListener("click", ()=> runAction("delete", getSelectedIds()));

  $("#btnClearNotices").addEventListener("click", ()=>{
    state.notifications.forEach(n=>n.read=true);
    toast("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã", "ok");
    renderNotifications();
    renderNotices();
  });

  $("#btnMarkAllRead").addEventListener("click", ()=>{
    state.notifications.forEach(n=>n.read=true);
    toast("–í—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ", "ok");
    renderNotifications();
    renderNotices();
  });
  $("#btnClearNotifications").addEventListener("click", ()=>{
    state.notifications = [];
    toast("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã", "warn");
    renderNotifications();
    renderNotices();
  });

  $("#btnSeed").addEventListener("click", ()=> { seedVms(4); renderAll(); });

  $("#btnExportVms").addEventListener("click", ()=>{
    addEvent("Export VMs (mock)", "", "");
    toast("–≠–∫—Å–ø–æ—Ä—Ç VMs (mock)", "info");
  });
  $("#btnExportEvents").addEventListener("click", ()=>{
    addEvent("Export Events (mock)", "", "");
    toast("–≠–∫—Å–ø–æ—Ä—Ç —Å–æ–±—ã—Ç–∏–π (mock)", "info");
  });

  $("#btnGoToVms").addEventListener("click", ()=> setView("vms"));

  $("#quotaCpu").addEventListener("input", ()=>{
    $("#quotaCpuValue").textContent = $("#quotaCpu").value;
    renderKpis();
  });

  $("#btnClearEvents").addEventListener("click", ()=>{
    state.events = [];
    toast("–°–æ–±—ã—Ç–∏—è –æ—á–∏—â–µ–Ω—ã", "warn");
    renderEvents();
    renderKpis();
  });
  $("#btnSeedEvents").addEventListener("click", ()=>{
    ["Health check ok","Scheduler tick","Quota recalculated"].forEach(t => addEvent(t,"",""));
    toast("–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è", "ok");
    renderEvents();
  });

  $("#btnMockLogin").addEventListener("click", ()=>{
    addEvent("Mock: user switched", "", "");
    toast("Mock: –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "info");
  });

  // Request VM
  $("#btnSubmitRequest").addEventListener("click", ()=>{
    const name = $("#reqName").value.trim() || `vm-${($("#reqProject").value.trim() || "dev").split(/[^\w]+/)[0] || "dev"}-${String(Math.floor(Math.random()*90)+10).padStart(2,"0")}`;
    const project = ($("#reqProject").value.trim().split(/[^\w]+/)[0] || "dev").toLowerCase();
    const template = $("#reqTemplate").value;
    const ttlHrs = Number($("#reqTtlHours").value);
    const cpu = Number($("#reqCpu").value);
    const ram = Number($("#reqRam").value);
    const disk = Number($("#reqDisk").value);

    const createdAt = new Date();
    const deleteAt = new Date(createdAt.getTime() + ttlHrs*36e5);
    const id = uid();
    const dns = `${name}.local`;

    state.vms.push({
      id, name, project, template,
      status: "Starting",
      cpu, ram, disk,
      ip: "",
      dns,
      tags: [project, template.includes("Windows") ? "win" : "linux", "requested"],
      createdAt,
      deleteAt
    });

    ensureProjectsInFilter();

    addEvent("Request VM submitted", name, "Starting");
    addNotification("info", `–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: ${name} (Starting)`, id);
    toast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (mock)", "ok");

    setTimeout(()=>{
      const vm = state.vms.find(v=>v.id===id);
      if (!vm) return;
      vm.status = "Running";
      vm.ip = `10.10.${Math.floor(Math.random()*10)}.${Math.floor(10+Math.random()*200)}`;
      vm.tags = Array.from(new Set([...(vm.tags||[]), "provisioned"]));
      addEvent("VM provisioned", vm.name, vm.status);
      addNotification("info", `–ì–æ—Ç–æ–≤–æ: ${vm.name} (Running)`, vm.id);
      toast(`${vm.name} –≥–æ—Ç–æ–≤–∞`, "ok");
      renderAll();
    }, 1500);

    bootstrap.Modal.getInstance($("#requestVmModal")).hide();
    $("#reqName").value = "";
    $("#reqComment").value = "";
    setView("vms");
  });

  // auto refresh (mock)
  setInterval(()=>{
    if (!$("#optAutoRefresh")?.checked) return;

    if (Math.random() < 0.12 && state.vms.length){
      const vm = state.vms[Math.floor(Math.random()*state.vms.length)];
      if (!vm) return;

      if (vm.status === "Running" && Math.random() < 0.35){
        vm.status = "Stopped";
        addEvent("Auto: VM stopped (mock)", vm.name, vm.status);
        addNotification("warn", `VM –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å (mock): ${vm.name}`, vm.id);
      } else if (vm.status === "Stopped" && Math.random() < 0.35){
        vm.status = "Running";
        vm.ip = vm.ip || `10.10.${Math.floor(Math.random()*10)}.${Math.floor(10+Math.random()*200)}`;
        addEvent("Auto: VM running (mock)", vm.name, vm.status);
      }
    }

    renderKpis();
    if (state.view === "vms") renderVmTable();
    if (state.view === "dashboard") renderNotices();
  }, 5000);

  // init
  $("#quotaCpuValue").textContent = $("#quotaCpu").value;
  applyTheme(loadTheme());
  setView("dashboard");
  renderAll();

  // focus search jumps to VM list (optional)
  $("#searchInput").addEventListener("focus", ()=>{
    if (state.view === "dashboard") setView("vms");
  });

})();
</script>
</body>
</html>
